---
name: Sync Mobile Lists
on:
  schedule:
    - cron: '0 0 * * *'  # yamllint disable-line rule:truthy
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Download mobile domain lists
        run: |
          mkdir -p data/mobile

          declare -a SOURCES=(
            "https://raw.githubusercontent.com/v2fly/domain-list-community/refs/heads/master/data/huawei|huawei"
            "https://raw.githubusercontent.com/v2fly/domain-list-community/refs/heads/master/data/huawei-dev|huawei-dev"
            "https://raw.githubusercontent.com/v2fly/domain-list-community/refs/heads/master/data/huaweicloud|huaweicloud"
            "https://raw.githubusercontent.com/v2fly/domain-list-community/refs/heads/master/data/xiaomi|xiaomi"
            "https://raw.githubusercontent.com/v2fly/domain-list-community/refs/heads/master/data/xiaomi-ai|xiaomi-ai"
            "https://raw.githubusercontent.com/v2fly/domain-list-community/refs/heads/master/data/xiaomi-iot|xiaomi-iot"
          )

          for entry in "${SOURCES[@]}"; do
            URL="${entry%%|*}"
            NAME="${entry##*|}"
            OUT_FILE="data/mobile/${NAME}"

            echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞: ${NAME}"

            if curl -sSL --fail -o "${OUT_FILE}" "${URL}"; then
              echo "‚úÖ ${NAME}: $(wc -l < "${OUT_FILE}") —Å—Ç—Ä–æ–∫"
            else
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å ${URL}"
            fi
          done

          echo "üìä –§–∞–π–ª–æ–≤ –≤ data/mobile/: $(ls -1 data/mobile/ 2>/dev/null | wc -l)"

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git status
          git add data/mobile/

          if ! git diff --staged --quiet; then
            git commit -m "chore: update mobile lists ($(date +%Y-%m-%d))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –ø—É—à –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi