---
name: Sync RU Lists
on:
  schedule:
    - cron: '0 0 * * *'  # yamllint disable-line rule:truthy
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          path: geosite-builder

      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: kirilllavrov/RU-domain-list-for-whitelist
          token: ${{ secrets.GH_PAT }}
          path: source-repo
          fetch-depth: 0

      - name: Sync and process RU domains
        run: |
          cd geosite-builder
          mkdir -p data/ru data/ads data/mobile

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã, –ø—Ä–∏–≤–æ–¥—è –∏–º–µ–Ω–∞ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
          for src in ../source-repo/domains/ru/*; do
            [ -f "$src" ] || continue
            fname=$(basename "$src" | tr '[:upper:]' '[:lower:]')
            cp "$src" "data/ru/$fname"
          done

          # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã –≤ —ç—Ç–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
          rm -f data/ru/category-ru data/ru/whitelist-ru

          # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –¥–æ–º–µ–Ω—ã, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
          for file in data/ru/*; do
            [ -f "$file" ] || continue
            sed -i -E 's/^#[[:space:]]*([a-zA-Z0-9][a-zA-Z0-9.-]*\.[a-zA-Z]{2,})[[:space:]]*$/\1/' "$file"
            echo "‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω: $(basename "$file")"
          done

          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º category-ru –±–µ–∑ ./ –∏ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
          echo "# Auto-generated RU category list" > data/category-ru
          echo "# Generated: $(date -Iseconds)" >> data/category-ru
          echo "" >> data/category-ru
          for file in data/ru/*; do
            [ -f "$file" ] || continue
            fname=$(basename "$file")
            echo "include:ru/${fname}" >> data/category-ru
          done

          echo "üìä –§–∞–π–ª–æ–≤ –≤ data/ru/: $(ls -1 data/ru/ 2>/dev/null | wc -l)"

      - name: Commit and push
        run: |
          cd geosite-builder
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git status
          git add data/ru/ data/category-ru

          if ! git diff --staged --quiet; then
            git commit -m "chore: sync RU domains ($(date +%Y-%m-%d))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –ø—É—à –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi