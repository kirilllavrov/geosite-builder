---
name: Build Geosite
on:
  schedule:
    - cron: '0 2 * * *'  # yamllint disable-line rule:truthy
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Clone v2fly builder
        run: |
          git clone --depth 1 \
            https://github.com/v2fly/domain-list-community.git builder

      - name: Flatten data for builder
        run: |
          rm -rf builder/data
          mkdir -p builder/data

          for dir in data/ru data/ads data/mobile \
                     data/streaming data/browser; do
            [ -d "$dir" ] || continue
            for file in "$dir"/*; do
              [ -f "$file" ] || continue
              fname=$(basename "$file")
              [[ "$fname" == category-* ]] && continue
              cp "$file" "builder/data/$fname"
            done
          done

          for cat in data/category-*; do
            [ -f "$cat" ] || continue
            cname=$(basename "$cat")
            sed 's|include:[^/]*/|include:|g' "$cat" \
              > "builder/data/$cname"
            echo "âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½: $cname"
          done

          echo "ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²: $(ls -1 builder/data/ | wc -l)"

      - name: Generate geosite.dat
        run: |
          cd builder
          if ! go run ./ --datapath=./data \
            --outputdir=./output; then
            echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸"
            exit 1
          fi
          mv ./output/dlc.dat ./output/geosite.dat
          echo "ğŸ“Š Ğ Ğ°Ğ·Ğ¼ĞµÑ€: $(ls -lh ./output/geosite.dat \
            | awk '{print $5}')"

      - name: Convert for Mihomo/Sing-box
        run: |
          cd builder
          go install github.com/metacubex/geo/cmd/geo@latest
          geo convert site \
            -i v2ray \
            -o sing \
            -f output/geosite.db \
            ./output/geosite.dat
          mkdir -p ../output
          cp ./output/geosite.dat ../output/
          cp ./output/geosite.db ../output/
          echo "ğŸ“Š geosite.dat: $(ls -lh ../output/geosite.dat \
            | awk '{print $5}')"
          echo "ğŸ“Š geosite.db: $(ls -lh ../output/geosite.db \
            | awk '{print $5}')"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Geosite build #${{ github.run_number }}  # yamllint disable-line rule:comments
          body: |
            ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° geosite Ğ´Ğ»Ñ Mihomo/Sing-box

            ğŸ”„ Run: #${{ github.run_number }}
            ğŸ”— Commit: ${{ github.sha }}
            ğŸ“¦ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹:
            - geosite.dat (V2Ray/Xray)
            - geosite.db (Sing-box/Mihomo)
          files: |
            output/geosite.dat
            output/geosite.db
          fail_on_unmatched_files: true
          make_latest: true
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Commit source changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git status
          git add data/
          if ! git diff --staged --quiet; then
            git commit -m "chore: sync source data ($(date +%Y-%m-%d))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "âœ… Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹"
          fi