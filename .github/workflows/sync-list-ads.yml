---
name: Sync Ads Lists
on:
  schedule:
    - cron: '0 0 * * *'  # yamllint disable-line rule:truthy
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Download Hagezi DNS blocklist
        run: |
          mkdir -p data/ads

          URL="https://raw.githubusercontent.com/hagezi/dns-blocklists/refs/heads/main/domains/pro.txt"
          OUT_FILE="data/ads/hagezi"

          echo "üì• Downloading Hagezi Pro list..."
          if curl -sSL --fail -o "${OUT_FILE}" "${URL}"; then
            lines=$(wc -l < "${OUT_FILE}")
            echo "‚úÖ Hagezi: ${lines} –¥–æ–º–µ–Ω–æ–≤"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å Hagezi Pro list"
            exit 1
          fi

          rm -f data/ads/adguarddns

          echo "üìÅ –§–∞–π–ª–æ–≤ –≤ data/ads/:"
          ls -1 data/ads/

      - name: Update category-ads
        run: |
          if [ -f data/category-ads ]; then
            sed -i 's|include:ads/adguarddns|include:ads/hagezi|g' data/category-ads
            sed -i 's|include:adguarddns|include:hagezi|g' data/category-ads
            echo "‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω data/category-ads"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            cat data/category-ads
          else
            echo "‚ö†Ô∏è data/category-ads –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º..."
            echo "include:ads/hagezi" > data/category-ads
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git status
          git add data/ads/ data/category-ads

          if ! git diff --staged --quiet; then
            git commit -m "chore: switch to Hagezi ($(date +%Y-%m-%d))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –ø—É—à –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi