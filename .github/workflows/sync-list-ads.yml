name: Sync Ads Files
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Download and process AdGuard DNS filter
        run: |
          set +e  # Не прерывать скрипт при ошибках grep
          mkdir -p data/ads
          
          # Скачиваем
          curl -sSL --fail -o data/ads/filter.txt \
            https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_15_DnsFilter/filter.txt
          
          if [ ! -f data/ads/filter.txt ]; then
            echo "❌ Ошибка: файл filter.txt не скачался"
            exit 1
          fi
          
          # Обработка по шагам с сохранением промежуточных результатов для отладки
          grep -v '^!' data/ads/filter.txt | \
          grep -v '^$' | \
          sed 's/||/\n/g' | \
          sed 's/\^.*//' | \
          sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | \
          grep -v '^$' | \
          sed 's/^\*\.//; s/^\*-//; s/^\*//; s/\.\*//; s/\*$//' | \
          grep -vE '^([0-9]{1,3}\.){3}[0-9]{1,3}' | \
          grep -iE '^[a-z0-9]([a-z0-9.-]*\.)+[a-z]{2,}$' | \
          sed 's/^0\.//' | \
          sort -u > data/ads/AdGuardDNS || true
          
          # Проверка результата
          if [ -f data/ads/AdGuardDNS ] && [ -s data/ads/AdGuardDNS ]; then
            echo "✅ Файл создан успешно"
            echo "Строк в результате: $(wc -l < data/ads/AdGuardDNS)"
            echo "Пример (первые 10):"
            head -10 data/ads/AdGuardDNS
          else
            echo "❌ Файл AdGuardDNS пуст или не создан"
            echo "Размер: $(ls -lh data/ads/AdGuardDNS 2>/dev/null || echo 'файл отсутствует')"
            # Покажем, что осталось после предпоследнего шага
            echo "Проверка после удаления IP (первые 10):"
            grep -v '^!' data/ads/filter.txt | grep -v '^$' | sed 's/||/\n/g' | sed 's/\^.*//' | grep -vE '^([0-9]{1,3}\.){3}[0-9]{1,3}' | head -10
          fi
          
          rm -f data/ads/filter.txt