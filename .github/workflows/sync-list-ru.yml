---
name: Sync RU Lists
on:
  schedule:
    - cron: '0 0 * * *'  # yamllint disable-line rule:truthy
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          path: geosite-builder

      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: kirilllavrov/RU-domain-list-for-whitelist
          token: ${{ secrets.GH_PAT }}
          path: source-repo
          fetch-depth: 0

      - name: Setup Python for IDN conversion
        run: |
          python3 -m pip install --quiet idna

      - name: Sync and process RU domains
        run: |
          cd geosite-builder
          mkdir -p data/ru

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          rm -rf data/ru/*
          cp -r ../source-repo/domains/ru/* data/ru/

          # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã –≤ —ç—Ç–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
          rm -f data/ru/category-ru data/ru/whitelist-ru

          # –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + punycode + –≤–∞–ª–∏–¥–∞—Ü–∏—è
          cat > /tmp/process_domains.py << 'PYEOF'
          import sys, re
          try:
              import idna
          except ImportError:
              print("‚ùå idna library not installed", file=sys.stderr)
              sys.exit(1)

          def to_punycode(domain):
              try:
                  return idna.encode(domain, uts46=True).decode('ascii').lower()
              except:
                  return None

          def is_valid_ascii_domain(d):
              return bool(re.match(r'^[a-z0-9]([a-z0-9.-]*[a-z0-9])?\.[a-z]{2,}$', d))

          for filepath in sys.argv[1:]:
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      lines = f.readlines()
                  result = []
                  for line in lines:
                      line = line.strip()
                      # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                      if not line or line.startswith('#'):
                          continue
                      # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º, –µ—Å–ª–∏ –¥–æ–º–µ–Ω –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
                      if line.startswith('#'):
                          line = line[1:].strip()
                      # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ punycode, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ-ASCII
                      if any(ord(c) > 127 for c in line):
                          converted = to_punycode(line)
                          if converted and is_valid_ascii_domain(converted):
                              result.append(converted)
                      elif is_valid_ascii_domain(line.lower()):
                          result.append(line.lower())
                  with open(filepath, 'w', encoding='utf-8') as f:
                      f.write('\n'.join(result) + '\n' if result else '')
                  print(f"‚úÖ {filepath}: {len(result)} –¥–æ–º–µ–Ω–æ–≤")
              except Exception as e:
                  print(f"‚ùå {filepath}: {e}", file=sys.stderr)
          PYEOF

          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ data/ru/
          python3 /tmp/process_domains.py data/ru/*

          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º category-ru –≤–Ω—É—Ç—Ä–∏ data/ru/ —Å –ø—É—Ç—è–º–∏ –±–µ–∑ ./
          {
            echo "# Auto-generated RU category list"
            echo "# Generated: $(date -Iseconds)"
            echo ""
            for file in data/ru/*; do
              [ -f "$file" ] || continue
              fname=$(basename "$file")
              echo "include:$fname"
            done
          } > data/ru/category-ru

          echo "üìä –§–∞–π–ª–æ–≤ –≤ data/ru/: $(ls -1 data/ru/ 2>/dev/null | wc -l)"
          echo "–ü—Ä–∏–º–µ—Ä (–ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞):"
          head -10 data/ru/* 2>/dev/null | head -10

      - name: Commit and push
        run: |
          cd geosite-builder
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git status
          git add data/ru/

          if ! git diff --staged --quiet; then
            git commit -m "chore: sync RU domains ($(date +%Y-%m-%d))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –ø—É—à –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi